module Matasano
  module Utils
    def hex_to_bytes(hexstr)
      [hexstr].pack("H*")
    end

    def bytes_to_hex(bytes)
      bytes.unpack("H*").first
    end

    def hex_to_base64(str)
      [hex_to_bytes(str)].pack("m0")
    end

    def base64_to_hex(str)
      bytes_to_hex(str.unpack("m0").first)
    end

    def fixed_xor(x, y)
      x.bytes.zip(y.bytes).reduce("") { |s, (a, b)| s << (a.to_i ^ b.to_i).chr }
    end

    def hamming_distance(x, y)
      x.bytes.zip(y.bytes).reduce(0) do |ham, (a, b)|
        val = a ^ b
        dist = 0
        while val > 0
          dist += 1
          val &= val - 1
        end

        ham + dist
      end
    end

    def find_cipher_key(str)
      0.upto(127)
       .map(&:chr)
       .sort_by { |k| ETAOINSHRDLU.call(decrypt(str, k.chr)) }
       .first
    end

    def find_decryption(str)
      key = find_cipher_key(str)
      decrypt(str, key)
    end

    def decrypt(str, key)
      keystr = repeating_key(key, str.length)

      fixed_xor(str, keystr)
    end
    alias_method :encrypt, :decrypt

    def repeating_key(key, length)
      key.chars.cycle.take(length).join
    end

    CHI_SQUARED = -> (v1, v2) {
      (v1 - v2) ** 2 / v1
    }

    ETAOINSHRDLU = ->(str) {
      # letters = {" "=>11.504526588730874, "e"=>11.240807440773812, "t"=>8.014230214426677, "a"=>7.227497588474234, "o"=>6.643421623200205, "i"=>6.164656324392252, "n"=>5.9726192267188205, "s"=>5.5991645943769415, "h"=>5.392968079363534, "r"=>5.298276975902442, "d"=>3.763750121682493, "l"=>3.5619784245878283, "u"=>2.4407295639784423}
      # letters = {"a"=>7.227497588474234, "b"=>1.320365666952805, "c"=>2.461968689988407, "d"=>3.763750121682493, "e"=>11.240807440773812, "f"=>1.971698864591722, "g"=>1.7832016212532855, "h"=>5.392968079363534, "i"=>6.164656324392252, "j"=>0.1353994283135249, "k"=>0.6831918866538642, "l"=>3.5619784245878283, "m"=>2.12922238249896, "n"=>5.9726192267188205, "o"=>6.643421623200205, "p"=>1.707094753050912, "q"=>0.08407154045611023, "r"=>5.298276975902442, "s"=>5.5991645943769415, "t"=>8.014230214426677, "u"=>2.4407295639784423, "v"=>0.8654943849060611, "w"=>2.088514057646528, "x"=>0.1327445375622793, "y"=>1.7469181143195958, "z"=>0.06548730519739113, " "=>11.504526588730874}
      # letters = {" "=>11, "e"=>11, "t"=>8, "a"=>7, "o"=>6, "i"=>6, "n"=>5, "s"=>5, "h"=>5, "r"=>5, "d"=>3, "l"=>3}

      letters = {"\n"=>0.012048192771084338, " "=>0.16006884681583478, "\""=>0.005737234652897304, "("=>0.0011474469305794606, ")"=>0.0011474469305794606, ","=>0.0068846815834767644, "-"=>0.0034423407917383822, "."=>0.010327022375215147, "/"=>0.0005737234652897303, "0"=>0.0005737234652897303, "1"=>0.0068846815834767644, "2"=>0.002868617326448652, "3"=>0.0005737234652897303, "4"=>0.002868617326448652, "5"=>0.0017211703958691911, "6"=>0.0005737234652897303, "7"=>0.0005737234652897303, "9"=>0.0034423407917383822, ":"=>0.0005737234652897303, "A"=>0.005737234652897304, "B"=>0.004016064257028112, "C"=>0.004016064257028112, "D"=>0.0017211703958691911, "E"=>0.0017211703958691911, "F"=>0.0005737234652897303, "G"=>0.0011474469305794606, "H"=>0.0005737234652897303, "I"=>0.006310958118187034, "J"=>0.0011474469305794606, "L"=>0.0005737234652897303, "M"=>0.0017211703958691911, "N"=>0.002294893861158921, "O"=>0.0011474469305794606, "P"=>0.002294893861158921, "Q"=>0.0017211703958691911, "S"=>0.0005737234652897303, "T"=>0.009753298909925417, "U"=>0.0005737234652897303, "W"=>0.006310958118187034, "a"=>0.06769936890418818, "b"=>0.013195639701663799, "c"=>0.03155479059093517, "d"=>0.03384968445209409, "e"=>0.08835341365461848, "f"=>0.01434308663224326, "g"=>0.01835915088927137, "h"=>0.029259896729776247, "i"=>0.06253585771658061, "k"=>0.006310958118187034, "l"=>0.030407343660355707, "m"=>0.021801491681009755, "n"=>0.04819277108433735, "o"=>0.04991394148020654, "p"=>0.011474469305794608, "r"=>0.05163511187607573, "s"=>0.03327596098680436, "t"=>0.05163511187607573, "u"=>0.022375215146299483, "v"=>0.005737234652897304, "w"=>0.010900745840504877, "x"=>0.002868617326448652, "y"=>0.01434308663224326, "z"=>0.002868617326448652, "|"=>0.0011474469305794606}
      letters.default = -0.1

      hist = str.chars
                .each_with_object(Hash.new(0)) { |c, h| h[c] = h[c] + (1.to_f / str.length) }

      # [letters.keys].uniq.reduce(0) { |chi, c| chi + CHI_SQUARED.call(letters[c], hist[c]) }

      str.chars.reduce(0) do |total, c|
        total -= letters[c]
      end
    }
    LETTER_FREQUENCY = ->(str) {
      letters = {
        "a" => 8167,
        "b" => 1492,
        "c" => 2782,
        "d" => 4253,
        "e" => 12702,
        "f" => 2228,
        "g" => 2015,
        "h" => 6094,
        "i" => 6966,
        "j" => 153,
        "k" => 772,
        "l" => 4025,
        "m" => 2406,
        "n" => 6749,
        "o" => 7507,
        "p" => 1929,
        "q" => 95,
        "r" => 5987,
        "s" => 6327,
        "t" => 9056,
        "u" => 2758,
        "v" => 978,
        "w" => 2360,
        "x" => 150,
        "y" => 1974,
        "z" => 74,
        " " => 13000
      }

      average = letters.values.reduce(:+) / letters.values.length
      str.chars
         .map(&:downcase)
         .reduce(0) { |acc, c| acc + letters.fetch(c, -1 * average) }
    }

    def find_decryption_in_file(filename)
      File.readlines(filename)
          .map    { |l| find_decryption(hex_to_bytes(l.chomp)) }
          .min_by { |s| ETAOINSHRDLU.call(s) }
    end
  end
end

